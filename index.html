<html>

    <!-- Vue Scripts -->
    <script src="https://unpkg.com/vue"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <!-- Style -->
    <link rel="stylesheet" type="text/css" href="style.css"/>

    <!-- Fonts -->
    <script src="https://use.fontawesome.com/a55bf4c5ff.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Asap:400,400i,500,500i,600,600i,700,700i|Overpass+Mono:300,400,600,700" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Hind:300,400,500,600,700" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Slab:100,300,400,700" rel="stylesheet">



    <div id="app">

        <div class="content-left">
            <h1>Janice</h1>

            <div v-if="user_info">
                <img v-bind:src="user_info.profile_img" alt="profile"/>
                <h3>Hello {{user_info.name}}</h3>
            </div>

            <div id="wordpress-control-center" class="control-panel">
                <h4>Wordpress Status : 
                    <span v-if="!notLoggedIntoWordpress">Logged In.</span>
                    <span v-if="notLoggedIntoWordpress">Not Logged In.</span>
                </h4>
                <button v-if="notLoggedIntoWordpress" v-on:click="oauth">Log In</button>

                <div v-if="!notLoggedIntoWordpress">
                    <h5>Select blog to write on.</h5>
                    <button v-if="!wp_sites" v-on:click="get_users_sites">Get Sites</button>
                    <select v-if="wp_sites">
                        <option v-for="wp_site in wp_sites" :value="wp_site">{{wp_site.url}} </option>
                    </select>
                </div>
            </div>

            <div id="medium-control-center" class="control-panel">
                <h4>Medium Status : 
                    <span v-if="!notLoggedIntoMedium">Logged In.</span>
                    <span v-if="notLoggedIntoMedium">Not Logged In.</span>
                </h4>
                <button v-on:click="mediumAuth">Log In</button>
            </div>


            <form id="blog-form" v-on:submit.prevent="submit_post">
                <input placeholder="tags" type="text" v-model="postForm.tags"/>
                <input type="submit" value="Submit"/>
            </form>
            <!-- {{postForm}} -->

            <hr>

            <!-- Hero Img functionality -->
            <div class="hero-img-container">
                <button v-on:click="get_images">Insert Cover/Hero Photo</button>
                <div v-for="photo in twitch" v-if="photo != null">
                    <img class="unsplash-photo-container" :src="photo.urls.regular" v-on:click="selectImg(photo.urls.regular)"/>
                </div>
                <p>provided by unsplash.com</p>
            </div>

            <hr>

            <!-- User Login Functionality -->
            <div class="user_login_dash">
                
                
            </div>
        </div>

    </div>


        <div class="content-right">
            <div class="contain-writer">

            <div class="toolbar">
                <!-- <a href="#" data-command='undo'><i class='fa fa-undo'></i></a> -->
                <!-- <a href="#" data-command='redo'><i class='fa fa-repeat'></i></a> -->
                <!-- <div class="fore-wrapper"><i class='fa fa-font' style='color:#C96;'></i>
                    <div class="fore-palette">
                    </div>
                </div>
                <div class="back-wrapper"><i class='fa fa-font' style='background:#C96;'></i>
                <div class="back-palette">
                </div> -->
                <!-- </div> -->
                <a href="#" data-command='bold'><i class='fa fa-bold'></i></a>
                <a href="#" data-command='italic'><i class='fa fa-italic'></i></a>
                <a href="#" data-command='underline'><i class='fa fa-underline'></i></a>
                <!-- <a href="#" data-command='strikeThrough'><i class='fa fa-strikethrough'></i></a> -->
                <!-- <a href="#" data-command='justifyLeft'><i class='fa fa-align-left'></i></a>
                <a href="#" data-command='justifyCenter'><i class='fa fa-align-center'></i></a>
                <a href="#" data-command='justifyRight'><i class='fa fa-align-right'></i></a>
                <a href="#" data-command='justifyFull'><i class='fa fa-align-justify'></i></a> -->
                <!-- <a href="#" data-command='indent'><i class='fa fa-indent'></i></a>
                <a href="#" data-command='outdent'><i class='fa fa-outdent'></i></a> -->
                <a href="#" data-command='insertUnorderedList'><i class='fa fa-list-ul'></i></a>
                <a href="#" data-command='insertOrderedList'><i class='fa fa-list-ol'></i></a>
                <a href="#" data-command='h1'>H1</a>
                <a href="#" data-command='h2'>H2</a>
                <!-- <a href="#" data-command='unlink'><i class='fa fa-unlink'></i></a> -->
                <!-- <a href="#" data-command='insertimage'><i class='fa fa-image'></i></a> -->
                <a href="#" data-command='p'>P</a>
                <a href="#" data-command='createlink'><i class='fa fa-link'></i></a>

                <!-- <a href="#" data-command='subscript'><i class='fa fa-subscript'></i></a>
                <a href="#" data-command='superscript'><i class='fa fa-superscript'></i></a> -->
                </div>

                <div id='editor' contenteditable>
                  <h1>Title</h1>
                  <p>You heart...</p>
                </div>
            </div>
        </div>


    <script type="text/javascript">

        var toolbar_a = document.getElementsByClassName('toolbar')[0].getElementsByTagName('a')
        for (var i = 0; i < toolbar_a.length; i++) {
            toolbar_a[i].onclick = function(){ elementChange(this) };
        }

        function elementChange(elem){
            console.log('elem:', elem);
            var command = elem.getAttribute('data-command');
            if (command == 'h1' || command == 'h2' || command == 'p') {
                document.execCommand('formatBlock', false, command);
            }
            else if (command == 'createlink' || command == 'insertimage') {
                url = prompt('Enter the link here: ', 'http:\/\/');
                document.execCommand(command, false, url);
            } 
            else {
                document.execCommand(command, false, null)
            };
        }
    </script>


    <script type="text/javascript">
        var app = new Vue({
            el: '#app',
            data: {
                twitch: [],
                notLoggedIntoWordpress: true,
                notLoggedIntoMedium: true,
                postForm:{title:'', body:'', tags:''},
                user_info: null,
                wp_sites: null
            },
            methods:{
                mediumAuth:function(){
                    window.location.href = "https://medium.com/m/oauth/authorize?client_id=1292420447db&scope=basicProfile,publishPost&state=janiceapp&response_type=code&redirect_uri=http://localhost:8000/";
                },
                mediumLongLivedToken(){
                    // POST /v1/tokens HTTP/1.1
                    // Host: api.medium.com
                    // Content-Type: application/x-www-form-urlencoded
                    // Accept: application/json
                    // Accept-Charset: utf-8
                },
                get_images:function(){
                    const vue = this
                    var url = 'https://api.unsplash.com/photos/random?count=5&query=computer&client_id=7549a368d3a30920c5312c24a4c62b892bc9c5bbe96d55f4b9aaf36671158b3e';
                    axios.get(url)
                        .then(function(response){
                            vue.twitch = response.data;
                        })
                        .catch(function (error) {
                            console.log(error);
                        });

                },
                selectImg:function(img_url){
                    console.log('You selected img_url:', img_url);
                },
                submit_post: function(){
                    const vue = this
                    console.log('submit_post: start of method:', vue.postForm);
                },
                upload_image_to_wp: function(){
                    // curl \
                    //  -H 'authorization: Bearer YOUR_API_TOKEN' \
                    //  --data-urlencode 'media_urls=https://s.w.org/about/images/logos/codeispoetry-rgb.png' \
                    //  'https://public-api.wordpress.com/rest/v1.1/sites/82974409/media/new'

                    var url = 'https://public-api.wordpress.com/rest/v1.1/sites/82974409/media/new'
                    url += '?media_urls=' + image_url
                    axios({
                        method: 'get',
                        url: url,
                        headers: {
                            'Authorization': 'BEARER ' + window.localStorage.getItem("access_token")
                        }
                    })

                },
                get_users_sites(){
                    var ac = window.localStorage.getItem("access_token");
                    const vue = this;
                    var url = 'https://public-api.wordpress.com/rest/v1.1/me/sites'
                    axios({
                        method: 'get',
                        url: url,
                        headers: {
                            'Authorization': 'BEARER ' + window.localStorage.getItem("access_token")
                        }
                    })
                    .then(function(response){
                        console.log('get_users_sites, response:', response);
                        if(response.status == 200){
                            var wp_sites = []
                            for(var i=0; i<response.data.sites.length; i++){
                                wp_site = response.data.sites[i]
                                wp_sites.push({
                                    "id":wp_site['ID'],
                                    "name":wp_site['name'],
                                    "url":wp_site['URL']
                                })
                            }
                            vue.wp_sites = wp_sites;
                            window.localStorage.setItem('wp_sites', JSON.stringify(wp_sites));
                        }
                        else{
                            alert('ERROR with getting sites.')
                        }
                    })
                    .catch(function(error){
                        alert(JSON.stringify(error));
                    })

                },
                oauth:function(){
                    //response_type=token for client, =code for server.
                    window.location.href = 'https://public-api.wordpress.com/oauth2/authorize?response_type=token&client_id=45998&state=81271fba7799d16e42a0bafbc008ab62&redirect_uri=http://localhost:8000&scope=global'
                },
                oauth_client_side:function(access_token, expires_in){
                    //token last two weeks
                    //test post
                    axios({
                        method: 'post',
                        url: 'https://public-api.wordpress.com/rest/v1.1/sites/108370734/posts/new/',
                        data: {
                            title:'hello2',
                            content:'this is 2 helo',
                            tags:'tests',
                            categories:'API',
                            status:'draft',
                            featured_image:null //exisiting attatchment id
                        },
                        headers: {
                            // 'content-type': 'application/json',
                            'Authorization': 'BEARER ' + access_token
                        }
                    })
                    .then(function(response) {
                        console.log('token?', response);
                    })
                    .catch(function(error){
                        console.log('error:', error);
                    });
                },
                // oauth_token_server_side:function(state, code){
                //     /*
                //     This is only to be used for server side code.
                //     */
                //     var payload = {
                //         'client_id':'45998',
                //         'redirect_uri':'http://localhost:8000',
                //         'client_secret':'Z9wnBuKVZMS9yXKCvn31SrljBOxmi9p1tfGGPSoODcviyYRd2cltuBIDjm5NCxfq',
                //         'code':code,
                //         'grant_type':'authorization_code'
                //     }
                //     // Send a POST request
                //     axios({
                //       method: 'post',
                //       url: 'https://public-api.wordpress.com/oauth2/token',
                //       data: payload,
                //       headers: {'content-type': 'application/javascript'}
                //     })
                //     .then(function(response) {
                //         console.log('token?', response);
                //     })
                //     .catch(function(error){
                //         console.log('error:', error);
                //     });

                // },
                check_url:function(){
                    // if(window.location.href.indexOf("code") > -1 && window.location.href.indexOf("state") > -1) {
                    //     var info = window.location.href.split('/?')[1];
                    //     code = info.substring(info.indexOf('code')+5,info.indexOf('&'))
                    //     state = info.substring(info.indexOf('code')+5,)
                    //     state = state.substring(state.indexOf('state')+6,)
                    //     console.log('state:', state, code)
                    //     this.oauth_token_server_side(state, code);
                    // }
                    // else 
                    const vue = this;

                    var myStorage = window.localStorage;

                    // myStorage.removeItem("wp_sites");
                    // myStorage.removeItem("access_token");


                    //check for wordpress sites
                    if(myStorage.getItem("wp_sites") !== null){
                        vue.wp_sites = JSON.parse(myStorage.getItem("wp_sites"));
                    }

                    if(window.localStorage.getItem('user_info') !== null){
                        vue.user_info = JSON.parse(window.localStorage.getItem('user_info'));
                    }

                    //check for Wordpress token
                    if(myStorage.getItem("access_token") !== null){
                        console.log('you have a access token.');
                        // const vue = this;
                        vue.notLoggedIntoWordpress = false;
                    }
                    else if(window.location.href.indexOf("access_token") > -1 && window.location.href.indexOf("expires_in") > -1) {
                        var info = window.location.href;
                        access_token = info.substring(info.indexOf('access_token')+13,info.indexOf('&'))
                        expires_in = info.substring(info.indexOf('access_token')+13,)
                        expires_in = expires_in.substring(expires_in.indexOf('expires_in')+11,)
                        expires_in = expires_in.substring(0,expires_in.indexOf('&'))

                        access_token = decodeURIComponent(access_token)
                        myStorage.setItem('access_token', access_token);
                        myStorage.setItem('expires_in', expires_in);

                        vue.notLoggedIntoWordpress = false;

                        //get user information and store into localstorage
                        var url = 'https://public-api.wordpress.com/rest/v1.1/me/'
                        axios({
                            method: 'get',
                            url: url,
                            headers: {
                                'Authorization': 'BEARER ' + window.localStorage.getItem("access_token")
                            }
                        })
                        .then(function(response){
                            console.log("me response:", response);
                            var user_info = {};
                            if (response.status == 200){
                                user_info['profile_img'] = response.data.avatar_URL;
                                user_info['name'] = response.data.display_name;
                                user_info['id'] = response.data.ID;
                                vue.user_info = user_info;
                                window.localStorage.setItem('user_info', JSON.stringify(user_info));
                            }
                            else{
                                alert("Failed get user information: " + JSON.stringify(response))
                            }
                        })
                        .catch(function(error){
                            alert(JSON.stringify(error));
                        })
                    }

                    if(vue.notLoggedIntoWordpress){
                        //when not logged in, then remove these if they exists
                        if(myStorage.getItem("wp_sites") !== null){
                            myStorage.removeItem("wp_sites");
                            vue.wp_sites = null;
                        }
                        if(window.localStorage.getItem('user_info') !== null){
                            myStorage.removeItem('user_info');
                            vue.user_info = null;
                        }   
                    }
                    
                    //check for Medium token
                    if(myStorage.getItem("medium_token") !== null){
                        console.log('you have a medium_token.');
                        // const vue = this;
                        vue.notLoggedIntoMedium = false;
                    }
                    else if(window.location.href.indexOf('code=') > -1 && window.location.href.indexOf('state=') > -1){
                        var info = window.location.href;
                        code = info.substring(info.indexOf('code=')+5,)

                        //now make api call to set the long period auth
                        var url = "https://api.medium.com//v1/tokens?code=" + code + "&client_id=1292420447db&client_secret=7b1d0c1d9a1ef5af7ad3cad5629c3956e6511724&grant_type=authorization_code&redirect_uri=http://www.pondersimple.com"

                        axios({
                            method: 'post',
                            url: url,
                            headers: {
                                "Content-Type": "application/x-www-form-urlencoded",
                                "Accept": "application/json",
                                "Accept-Charset": "utf-8"
                            }
                        })
                        .then(function(response) {
                            console.log('medium token?', response);
                            
                            //now set the token to localstorage
                            // myStorage.setItem('medium_token', medium_token);

                        })
                        .catch(function(error){
                            console.log('medium token, error:', error);
                        });
                    }
                }
            },
            // created: function(){}
        })
        app.check_url();

    </script>

</html>

